FROM apache/airflow:2.10.5

ARG AIRFLOW_UID=1000
ARG AIRFLOW_GID=0

# Ensure the 'airflow' user exists with the requested IDs (works whether it already exists or not)
RUN set -eux; \
    if id -u airflow >/dev/null 2>&1; then \
      usermod -u "${AIRFLOW_UID}" airflow || true; \
      usermod -g "${AIRFLOW_GID}" airflow || true; \
    else \
      if [ "${AIRFLOW_GID}" != "0" ]; then \
        groupadd -g "${AIRFLOW_GID}" airflow || true; \
        useradd -m -u "${AIRFLOW_UID}" -g "${AIRFLOW_GID}" -s /bin/bash airflow || true; \
      else \
        useradd -m -u "${AIRFLOW_UID}" -g 0 -s /bin/bash airflow || true; \
      fi; \
    fi

RUN pip install --no-cache-dir dbt-snowflake==1.9.4 gtfs_kit gtfs-realtime-bindings

USER airflow
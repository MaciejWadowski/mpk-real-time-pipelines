name: Deploy to self-hosted host

on:
  push:
    branches:
      - '**'

jobs:
  deploy:
    runs-on: self-hosted
    env:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      AIRFLOW_FERNET_KEY: ${{ secrets.AIRFLOW_FERNET_KEY }}
      DBT_USER: ${{ secrets.DBT_USER }}
      DBT_PASSWORD: ${{ secrets.DBT_PASSWORD }}
      DBT_SCHEMA: ${{ secrets.DBT_SCHEMA }}
      DBT_ACCOUNT: ${{ secrets.DBT_ACCOUNT }}
      DBT_WAREHOUSE: ${{ secrets.DBT_WAREHOUSE }}
      DBT_DATABASE: ${{ secrets.DBT_DATABASE }}
      DBT_ROLE: ${{ secrets.DBT_ROLE }}
    steps:
      - uses: actions/checkout@v4
        with:
          clean: false

      - name: Generate dbt profiles.yml in repo/dbt
        run: |
          mkdir -p dbt
          if ! command -v envsubst >/dev/null 2>&1; then
            python - <<'PY'
          import os
          from string import Template
          t = Template(open('dbt/test-profiles.yml').read())
          open('dbt/profiles.yml','w').write(t.safe_substitute(os.environ))
          PY
          else
            envsubst < dbt/test-profiles.yml > dbt/profiles.yml
          fi
      
      - name: Create .env file with all variables
        run: |
          mkdir -p ./dags ./logs ./plugins ./config
        
          cat > .env <<EOF
          AIRFLOW_UID=$(id -u)
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          AIRFLOW_FERNET_KEY=${{ secrets.AIRFLOW_FERNET_KEY }}
          DBT_USER=${{ secrets.DBT_USER }}
          DBT_PASSWORD=${{ secrets.DBT_PASSWORD }}
          DBT_SCHEMA=${{ secrets.DBT_SCHEMA }}
          DBT_ACCOUNT=${{ secrets.DBT_ACCOUNT }}
          DBT_WAREHOUSE=${{ secrets.DBT_WAREHOUSE }}
          DBT_DATABASE=${{ secrets.DBT_DATABASE }}
          DBT_ROLE=${{ secrets.DBT_ROLE }}
          EOF

      - name: Stop services if running 
        run: docker compose stop

      - name: Init airflow
        run: docker compose up airflow-init

      - name: Deploy (build & run)
        run: docker compose up -d --build --remove-orphans

      - name: Health / status
        run: |
          set -euo pipefail
          TIMEOUT=300
          INTERVAL=10
          END=$((SECONDS+TIMEOUT))

          if [ ${#services[@]} -eq 0 ]; then
            echo "No services found in compose file" >&2
            docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
            exit 1
          fi

          N=${#services[@]}
          echo "Waiting up to ${TIMEOUT}s for ${N} services to report '(healthy)' (interval ${INTERVAL}s)..."
          while [ $SECONDS -lt $END ]; do 
            echo "$out"
            healthy_count=$(echo "$out" | grep -c '(healthy)' || true)
            if [ "${healthy_count}" -eq "${N}" ]; then
              echo "All services healthy"
              docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
              exit 0
            fi
            sleep ${INTERVAL}
          done
          docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
          docker compose -f docker-compose.yml -f docker-compose.prod.yml logs --tail 200
          exit 1
name: Deploy to self-hosted host

on:
  push:
    branches:
      - '**'

jobs:
  deploy:
    runs-on: self-hosted
    env:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      AIRFLOW_FERNET_KEY: ${{ secrets.AIRFLOW_FERNET_KEY }}
      DBT_USER: ${{ secrets.DBT_USER }}
      DBT_PASSWORD: ${{ secrets.DBT_PASSWORD }}
      DBT_SCHEMA: ${{ secrets.DBT_SCHEMA }}
      DBT_ACCOUNT: ${{ secrets.DBT_ACCOUNT }}
      DBT_WAREHOUSE: ${{ secrets.DBT_WAREHOUSE }}
      DBT_DATABASE: ${{ secrets.DBT_DATABASE }}
      DBT_ROLE: ${{ secrets.DBT_ROLE }}
    steps:
      - uses: actions/checkout@v4
        with:
          clean: false

      - name: Generate dbt profiles.yml in repo/dbt
        run: |
          mkdir -p dbt
          if ! command -v envsubst >/dev/null 2>&1; then
            python - <<'PY'
          import os
          from string import Template
          t = Template(open('dbt/test-profiles.yml').read())
          open('dbt/profiles.yml','w').write(t.safe_substitute(os.environ))
          PY
          else
            envsubst < dbt/test-profiles.yml > dbt/profiles.yml
          fi

      - name: Pull images (best-effort)
        run: docker compose -f docker-compose.yml pull || true

      - name: Ensure repo-local Airflow dirs
        run: |
          mkdir -p ./logs ./dags ./plugins

      - name: Deploy (build & run)
        run: docker compose -f docker-compose.yml up -d --build --remove-orphans

      - name: Health / status
        run: docker compose -f docker-compose.yml ps
name: Deploy to self-hosted host

on:
  push:
    branches:
      - '**'

jobs:
  deploy:
    runs-on: self-hosted
    env:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      AIRFLOW_FERNET_KEY: ${{ secrets.AIRFLOW_FERNET_KEY }}
      DBT_USER: ${{ secrets.DBT_USER }}
      DBT_PASSWORD: ${{ secrets.DBT_PASSWORD }}
      DBT_SCHEMA: ${{ secrets.DBT_SCHEMA }}
      DBT_ACCOUNT: ${{ secrets.DBT_ACCOUNT }}
      DBT_WAREHOUSE: ${{ secrets.DBT_WAREHOUSE }}
      DBT_DATABASE: ${{ secrets.DBT_DATABASE }}
      DBT_ROLE: ${{ secrets.DBT_ROLE }}
    steps:
      - uses: actions/checkout@v4
        with:
          clean: false

      - name: Generate dbt profiles.yml in repo/dbt
        run: |
          mkdir -p dbt
          if ! command -v envsubst >/dev/null 2>&1; then
            python - <<'PY'
          import os
          from string import Template
          t = Template(open('dbt/test-profiles.yml').read())
          open('dbt/profiles.yml','w').write(t.safe_substitute(os.environ))
          PY
          else
            envsubst < dbt/test-profiles.yml > dbt/profiles.yml
          fi


      - name: Pull images (best-effort)
        run: docker compose -f docker-compose.yml pull || true

      - name: Ensure repo-local Airflow dirs
        run: |
          mkdir -p ./logs ./dags ./plugins

      - name: Deploy (build & run)
        run: docker compose -f docker-compose.yml up -d --build --remove-orphans

      - name: Health / status
        run: |
          set -euo pipefail
          # Timeout and interval can be overridden via env vars (use shell defaults to avoid invalid GH expr)
          TIMEOUT=${HEALTH_TIMEOUT:-300}
          INTERVAL=${HEALTH_INTERVAL:-5}
          END=$((SECONDS+TIMEOUT))

          services=( $(docker compose -f docker-compose.yml ps --services) )
          if [ ${#services[@]} -eq 0 ]; then
            echo "No services found in compose file" >&2
            docker compose -f docker-compose.yml ps
            exit 1
          fi

          echo "Waiting up to ${TIMEOUT}s for services to become healthy (poll interval ${INTERVAL}s)..."

          while [ $SECONDS -lt $END ]; do
            ALL_OK=true
            for svc in "${services[@]}"; do
              cid=$(docker compose -f docker-compose.yml ps -q "${svc}") || true
              if [ -z "${cid}" ]; then
                echo "Service ${svc} has no container yet";
                ALL_OK=false; continue
              fi

              restart_count=$(docker inspect -f '{{.RestartCount}}' "${cid}" 2>/dev/null || echo 0)
              if [ "${restart_count}" -gt 0 ]; then
                echo "Service ${svc} has restart count=${restart_count}";
                ALL_OK=false; continue
              fi

              status=$(docker inspect -f '{{if .State.Health}}{{.State.Health.Status}}{{else}}{{.State.Status}}{{end}}' "${cid}" 2>/dev/null || echo "unknown")
              if [ "${status}" = "healthy" ] || [ "${status}" = "running" ]; then
                echo "Service ${svc} status=${status}";
              else
                echo "Service ${svc} not ready: ${status}";
                ALL_OK=false
              fi
            done

            if [ "${ALL_OK}" = true ]; then
              echo "All services healthy"
              docker compose -f docker-compose.yml ps
              exit 0
            fi
            sleep ${INTERVAL}
          done

          echo "Timeout waiting for healthy services" >&2
          docker compose -f docker-compose.yml ps
          docker compose -f docker-compose.yml logs --tail 200
          exit 1